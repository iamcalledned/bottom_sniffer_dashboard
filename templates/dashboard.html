<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ config.dashboard_name }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .section-title {
      font-weight: 600;
      margin-bottom: 0.5rem;
      border-bottom: 2px solid #dee2e6;
      padding-bottom: 0.25rem;
    }
    .indicator-card {
      border-radius: 0.75rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      transition: all 0.2s ease-in-out;
    }
    .indicator-card:hover {
      transform: scale(1.02);
    }
    .indicator-value {
      font-size: 2rem;
      font-weight: bold;
    }
    .green { color: #198754; }
    .yellow { color: #ffc107; }
    .red { color: #dc3545; }
    .sniff-meter {
      font-size: 4rem;
    }
    .category-section {
      margin-top: 2rem;
    }
  </style>
</head>
<body onload="initIndicators()">
  <div class="container py-5">
    <h1 class="text-center mb-4">{{ config.dashboard_name }}</h1>

    <div class="text-center mb-5">
      <h2>üî• Sniff-O-Meter</h2>
      <div id="sniff-meter" class="sniff-meter" title="The lower the score, the chiller the market.">‚è≥</div>
    </div>

    {% for category in config.categories %}
      <div class="category-section">
        <h4 class="section-title text-primary">{{ category.category }}</h4>
        <div class="row">
          {% for indicator in category.indicators %}
            <div class="col-md-4 col-lg-3 mb-4">
              <div class="card indicator-card border-start border-4 border-warning">
                <div class="card-body">
                  <h6 class="card-subtitle mb-2 text-muted">{{ indicator }}</h6>
                  <div class="indicator-value" id="{{ indicator|replace(' ', '_') }}" data-indicator="{{ indicator }}">
                    <span class="spinner">‚è≥</span>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endfor %}
  </div>

  <script>
    function fetchIndicator(indicatorName, elementId) {
      fetch('/api/indicator/' + encodeURIComponent(indicatorName))
        .then(response => response.json())
        .then(data => {
          const el = document.getElementById(elementId);
          if (data.value !== null && data.value !== undefined) {
            const value = data.value.toFixed(4);
            let cls = "green";

            if (indicatorName.includes("Curve") && data.value < 0) {
              cls = "red";
            } else if (indicatorName.includes("Unemployment") && data.value > 5) {
              cls = "red";
            } else if (indicatorName.includes("CPI") && data.value > 4) {
              cls = "red";
            } else if (data.value === 0) {
              cls = "yellow";
            }

            el.innerHTML = `<span class="${cls}" title="Latest as of today. Click for history.">${value}</span>`;

            if (indicatorName === "Stress Composite Score") {
              updateSniffMeter(data.value);
            }
          } else {
            el.innerText = data.error || "N/A";
          }
        })
        .catch(err => {
          console.error("Fetch error:", err);
          document.getElementById(elementId).innerText = "N/A";
        });
    }

    function initIndicators() {
      const elements = document.querySelectorAll('[data-indicator]');
      elements.forEach(el => {
        const indicator = el.getAttribute('data-indicator');
        fetchIndicator(indicator, el.id);
      });
    }

    function updateSniffMeter(score) {
      const el = document.getElementById("sniff-meter");
      if (!el) return;
      if (score > 90) el.innerText = "üíÄ";
      else if (score > 75) el.innerText = "üö®";
      else if (score > 50) el.innerText = "üò¨";
      else if (score > 30) el.innerText = "üòê";
      else el.innerText = "üòéüö¨";
    }
  </script>
</body>
</html>
