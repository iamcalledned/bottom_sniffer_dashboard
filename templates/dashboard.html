<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bottom Sniffer Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' };
  </script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.0.0/dist/full.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" />
  <style>
    body { font-family: 'Inter', sans-serif; }
    .fade-in { animation: fadeIn 1s ease-in-out; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="bg-neutral text-neutral-content" onload="initIndicators()">

  <div class="max-w-7xl mx-auto p-4">
    <div class="text-center mb-10">
      <h1 class="text-4xl font-bold">Bottom Sniffer Dashboard</h1>
      <div class="text-sm text-gray-400 mt-2">Updated: <span id="timestamp">{{ now }}</span></div>
    </div>

    <!-- Sniff-O-Meter -->
    <div class="text-center mb-12">
      <h2 class="text-2xl font-semibold mb-2">üî• Sniff-O-Meter</h2>
      <div id="sniff-meter" class="text-6xl transition-all duration-500">‚è≥</div>
    </div>

    <!-- Dashboard Sections -->
    {% for category in config.categories %}
      <div class="mb-10">
        <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
          {% if "Macro" in category.category %}üìâ{% elif "Stress" in category.category %}üß®{% elif "Flight" in category.category %}üí∞{% endif %}
          {{ category.category }}
        </h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
          {% for indicator in category.indicators %}
            <div class="card bg-base-200 shadow-md fade-in">
              <div class="card-body">
                <h4 class="card-title text-base-content text-sm">{{ indicator }}</h4>
                <div id="{{ indicator|replace(' ', '_') }}" class="text-3xl font-bold" data-indicator="{{ indicator }}">
                  <span class="loading loading-dots loading-md"></span>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endfor %}

    <!-- Meta View -->
    <div class="mt-16 text-center">
      <h2 class="text-2xl font-semibold mb-4">Meta Stress Score</h2>
      <div id="Stress_Composite_Score" class="text-5xl font-extrabold text-primary animate-pulse" data-indicator="Stress Composite Score">‚è≥</div>
    </div>

    <!-- Footer -->
    <footer class="mt-16 text-center text-sm text-gray-500">
      Data from FRED, Yahoo Finance, and other elite sniffer sources. Built with ‚ù§Ô∏è by Sniffer Labs‚Ñ¢
    </footer>
  </div>

  <script>
    function fetchIndicator(indicatorName, elementId) {
      fetch('/api/indicator/' + encodeURIComponent(indicatorName))
        .then(res => res.json())
        .then(data => {
          const el = document.getElementById(elementId);
          if (!el) return;
          if (data.value !== null && data.value !== undefined) {
            const value = data.value.toFixed(2);
            let cls = "text-success";

            if (indicatorName.includes("Curve") && data.value < 0) cls = "text-error";
            else if (indicatorName.includes("Unemployment") && data.value > 5) cls = "text-error";
            else if (indicatorName.includes("CPI") && data.value > 4) cls = "text-error";
            else if (data.value === 0) cls = "text-warning";

            el.innerHTML = `<span class="${cls}">${value}</span>`;
            if (indicatorName === "Stress Composite Score") updateSniffMeter(data.value);
          } else {
            el.innerHTML = '<span class="text-warning">N/A</span>';
          }
        })
        .catch(() => {
          document.getElementById(elementId).innerHTML = '<span class="text-warning">N/A</span>';
        });
    }

    function initIndicators() {
      const elements = document.querySelectorAll('[data-indicator]');
      elements.forEach(el => {
        const indicator = el.getAttribute('data-indicator');
        fetchIndicator(indicator, el.id);
      });

      const ts = document.getElementById("timestamp");
      if (ts) {
        ts.innerText = new Date().toLocaleString();
      }
    }

    function updateSniffMeter(score) {
      const el = document.getElementById("sniff-meter");
      if (!el) return;
      if (score > 90) el.innerText = "üíÄ";
      else if (score > 75) el.innerText = "üö®";
      else if (score > 50) el.innerText = "üò¨";
      else if (score > 30) el.innerText = "üòê";
      else el.innerText = "üòéüö¨";
    }
  </script>
</body>
</html>
