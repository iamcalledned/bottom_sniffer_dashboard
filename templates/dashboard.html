<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ config.dashboard_name }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .spinner {
      animation: blink 1s step-start infinite;
      color: #aaa;
    }
    @keyframes blink {
      50% { opacity: 0; }
    }
    .alert-green { color: #198754; font-weight: bold; }
    .alert-yellow { color: #ffc107; font-weight: bold; }
    .alert-red { color: #dc3545; font-weight: bold; }
  </style>
</head>
<body onload="initIndicators()">
  <div class="container mt-4">
    <h1 class="mb-4 text-center">{{ config.dashboard_name }}</h1>

    <div class="text-center my-4">
      <h2>üî• Sniff-O-Meter</h2>
      <div id="sniff-meter" style="font-size: 4rem;" title="The lower the score, the chiller the market.">‚è≥</div>
    </div>

    {% for category in config.categories %}
      <div class="mb-5">
        <h3 class="text-primary border-bottom pb-1">{{ category.category }}</h3>
        <div class="row">
          {% for indicator in category.indicators %}
            <div class="col-md-4 mb-3">
              <div class="card shadow-sm border-start border-5 border-warning">
                <div class="card-body">
                  <h5 class="card-title">{{ indicator }}</h5>
                  <p class="card-text display-6" id="{{ indicator|replace(' ', '_') }}" data-indicator="{{ indicator }}">
                    <span class="spinner">‚è≥</span>
                  </p>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endfor %}
  </div>

  <script>
    function fetchIndicator(indicatorName, elementId) {
      fetch('/api/indicator/' + encodeURIComponent(indicatorName))
        .then(response => response.json())
        .then(data => {
          const el = document.getElementById(elementId);
          if (data.value !== null && data.value !== undefined) {
            const value = data.value.toFixed(4);
            let cls = "alert-green";

            if (indicatorName.includes("Curve") && data.value < 0) {
              cls = "alert-red";
            } else if (indicatorName.includes("Unemployment") && data.value > 5) {
              cls = "alert-red";
            } else if (indicatorName.includes("CPI") && data.value > 4) {
              cls = "alert-red";
            } else if (data.value === 0) {
              cls = "alert-yellow";
            }

            el.innerHTML = `<span class="${cls}" title="Latest as of today. Click for history.">${value}</span>`;

            if (indicatorName === "Stress Composite Score") {
              updateSniffMeter(data.value);
            }
          } else {
            el.innerText = data.error || "N/A";
          }
        })
        .catch(err => {
          console.error("Fetch error:", err);
          document.getElementById(elementId).innerText = "N/A";
        });
    }

    function initIndicators() {
      const elements = document.querySelectorAll('[data-indicator]');
      elements.forEach(el => {
        const indicator = el.getAttribute('data-indicator');
        fetchIndicator(indicator, el.id);
      });
    }

    function updateSniffMeter(score) {
      const el = document.getElementById("sniff-meter");
      if (!el) return;
      if (score > 90) el.innerText = "üíÄ";
      else if (score > 75) el.innerText = "üö®";
      else if (score > 50) el.innerText = "üò¨";
      else if (score > 30) el.innerText = "üòê";
      else el.innerText = "üòéüí®";
    }
  </script>
</body>
</html>
